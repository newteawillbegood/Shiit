<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>拉屎记录器</title>
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Firebase Web SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    // ---- Firebase Config ----
    const firebaseConfig = {
      apiKey: "AIzaSyBHm529okQCML4dtGIiwWY9L-0_dEglaL0",
      authDomain: "shiit-a2d59.firebaseapp.com",
      databaseURL: "https://shiit-a2d59-default-rtdb.firebaseio.com",
      projectId: "shiit-a2d59",
      storageBucket: "shiit-a2d59.appspot.com",
      messagingSenderId: "394472600873",
      appId: "1:394472600873:web:98da9f2eedf522afd4b338",
      measurementId: "G-NDY4BDJS81"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const evtRef = ref(db, "events");

    // ---- DOM Refs ----
    const monthTitle = document.getElementById('monthTitle');
    const calendarGrid = document.getElementById('calendarGrid');
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');
    const wawaTotal = document.getElementById('wawaTotal');
    const xiaowuTotal = document.getElementById('xiaowuTotal');
    const recordList = document.getElementById('recordList');
    const dtInput = document.getElementById('selectDateTime');

    // ---- State ----
    const events = []; // {time:dayjs, person}
    const dailyCounts = {};
    let currentDate = dayjs().startOf('month');

    // ---- Firebase listeners ----
    onValue(evtRef, snap => {
      events.length = 0; // reset
      Object.keys(dailyCounts).forEach(k => delete dailyCounts[k]);
      const data = snap.val() || {};
      Object.entries(data).forEach(([id, e]) => {
        const t = dayjs(e.time);
        events.push({ id, person: e.person, time: t });
        const key = t.format('YYYY-MM-DD');
        if (!dailyCounts[key]) dailyCounts[key] = { wawa: 0, xiaowu: 0 };
        dailyCounts[key][e.person]++;
      });
      renderCalendar(currentDate);
    });

    // ---- Helper to push event ----
    function addEvent(person, time) {
      push(evtRef, { person, time: time.toISOString() });
    }

    // ---- Delete (remove) ----
    window.deleteEvent = id => {
      remove(ref(db, `events/${id}`));
    };

    // ---- Rendering functions (same as before) ----
    function renderCalendar(date) {
      monthTitle.textContent = date.format('YYYY年MM月');
      calendarGrid.innerHTML = '';
      ['日','一','二','三','四','五','六'].forEach(d=>{const h=document.createElement('div');h.textContent=d;h.className='font-bold text-sm';calendarGrid.appendChild(h);});
      const start = date.startOf('month').day();
      for(let i=0;i<start;i++) calendarGrid.appendChild(document.createElement('div'));
      const days = date.daysInMonth();
      for(let d=1;d<=days;d++){
        const full = date.date(d).format('YYYY-MM-DD');
        const cell = document.createElement('div');cell.className='py-1 border rounded flex flex-col items-center';cell.innerHTML=`<span>${d}</span>`;
        const cnt = dailyCounts[full] || { wawa:0, xiaowu:0 };
        if(cnt.wawa+cnt.xiaowu){const tag=document.createElement('div');tag.className='text-xs mt-0.5';tag.innerHTML=`<span class='text-green-600'>蛙:${cnt.wawa}</span> <span class='text-blue-600'>吴:${cnt.xiaowu}</span>`;cell.appendChild(tag);} 
        if(dayjs().isSame(date.date(d),'day')) cell.classList.add('border-blue-400');
        calendarGrid.appendChild(cell);
      }
      renderTotals();
      renderList();
    }

    function renderTotals(){
      const key = currentDate.format('YYYY-MM');let w=0,x=0;Object.entries(dailyCounts).forEach(([d,c])=>{if(d.startsWith(key)){w+=c.wawa;x+=c.xiaowu;}});wawaTotal.textContent=`蛙蛙本月次数: ${w}`;xiaowuTotal.textContent=`小吴本月次数: ${x}`;}

    function renderList(){
      recordList.innerHTML='';
      const key=currentDate.format('YYYY-MM');
      events.filter(e=>e.time.format('YYYY-MM')===key).sort((a,b)=>a.time-b.time).forEach(e=>{
        const li=document.createElement('li');
        li.innerHTML=`${e.time.format('MM-DD HH:mm')} - <span class='${e.person==='wawa'?'text-green-600':'text-blue-600'}'>${e.person==='wawa'?'蛙蛙':'小吴'}</span> <button onclick='deleteEvent("${e.id}")' class='text-red-500 underline text-xs'>撤销</button>`;
        recordList.appendChild(li);
      });
    }

    // ---- Button handlers ----
    document.getElementById('addWawa').onclick = ()=> addEvent('wawa', dayjs());
    document.getElementById('addXiaowu').onclick = ()=> addEvent('xiaowu', dayjs());
    document.getElementById('addWawaDate').onclick = ()=>{ if(dtInput.value) addEvent('wawa', dayjs(dtInput.value)); };
    document.getElementById('addXiaowuDate').onclick = ()=>{ if(dtInput.value) addEvent('xiaowu', dayjs(dtInput.value)); };
    prevBtn.onclick = ()=>{ currentDate = currentDate.subtract(1,'month'); renderCalendar(currentDate); };
    nextBtn.onclick = ()=>{ currentDate = currentDate.add(1,'month'); renderCalendar(currentDate); };

    // ---- First render (will be updated by listener) ----
    renderCalendar(currentDate);
  </script>
</head>
<body></body>
</html>
